<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.org.quoteservice.server.adapter.out.persistence.mapper.SymbolMapper">
  <select id="findExchangeIdByCode" parameterType="string" resultType="int">
    SELECT id FROM exchanges WHERE code = #{code}
  </select>
  <select id="findCategoryIdByCode" parameterType="string" resultType="int">
    SELECT id FROM asset_categories WHERE name = #{code}
  </select>
  <insert id="upsertSymbol" parameterType="com.org.quoteservice.server.application.dto.SymbolUpsert">
    INSERT INTO symbols(source,category_id,symbol,symbol_origin,exchange_id,currency,is_active)
    VALUES (#{source},#{categoryId},#{symbol},#{symbolOrigin},#{exchangeId},#{currency},#{isActive})
    ON DUPLICATE KEY UPDATE id=LAST_INSERT_ID(id),
      symbol_origin=VALUES(symbol_origin), exchange_id=VALUES(exchange_id),
      currency=VALUES(currency), is_active=VALUES(is_active);
  </insert>
  <select id="lastInsertId" resultType="long">SELECT LAST_INSERT_ID()</select>
  <!-- listInstruments query disabled for now.
  <select id="listInstruments" parameterType="com.org.quoteservice.server.application.dto.ListInstrumentsQuery" resultType="map">
    SELECT id, source, category_id AS categoryId, symbol, symbol_origin AS symbolOrigin,
          exchange_id AS exchangeId, currency, is_active AS isActive
    FROM symbols
    <where>
      <if test="source != null">AND source = #{source}</if>
      <if test="categoryId != null">AND category_id = #{categoryId}</if>
      <if test="symbolLike != null">AND symbol LIKE CONCAT('%', #{symbolLike}, '%')</if>
    </where>
    ORDER BY symbol ASC
    LIMIT #{limit}
  </select>
  -->
</mapper>
